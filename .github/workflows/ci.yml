name: CI Pipeline

# トリガー: mainブランチへのプッシュとPR
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  # バックエンドのテスト
  test-backend:
    name: Test Backend
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          cd backend
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
      
      - name: Run linting (ruff)
        run: |
          cd backend
          python -m pip install ruff
          ruff check app/ 
      
      # - name: Check code formatting (black)
      #   run: |
      #     cd backend
      #     python -m pip install black
      #     black --check app/ 

      - name: Run tests (pytest)
        env:
          DATABASE_URL: postgresql+asyncpg://u:p@localhost:5432/test
        run: |
          cd backend
          python -m pytest -q

      - name: Dependency vulnerability check (pip-audit)
        run: |
          cd backend
          python -m pip install pip-audit
          pip-audit -r requirements.txt

  # フロントエンドのビルドテスト
  test-frontend:
    name: Test Frontend
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        run: |
          cd frontend
          npm ci
      
      - name: Type check (tsc)
        run: |
          cd frontend
          npm run typecheck

      - name: Lint (eslint)
        run: |
          cd frontend
          npm run lint

      - name: Dependency vulnerability check (npm audit)
        run: |
          cd frontend
          npm audit --audit-level=high

      - name: Build frontend
        run: |
          cd frontend
          npm run build

  # シークレット検知
  secret-scan:
    name: Secret Scan (gitleaks)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  codeql:
    name: SAST (CodeQL)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    
    strategy:
      fail-fast: false
      matrix:
        language: ['python', 'javascript-typescript']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}

      - name: Autobuild
        uses: github/codeql-action/autobuild@v4

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4

  # デプロイジョブ（CI成功後に実行）
  deploy:
    name: Deploy to Production
    # mainブランチへのプッシュ時のみ実行（PRではスキップ）
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    # すべてのCIジョブが成功した後に実行
    needs: [test-backend, test-frontend, secret-scan, codeql]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Render（バックエンド）へのデプロイ
      - name: Deploy to Render (Backend)
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          echo "Triggering Render deployment..."
          curl -X POST "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys" \
            -H "Authorization: Bearer ${RENDER_API_KEY}" \
            -H "Content-Type: application/json" \
            --fail --silent --show-error

      # Vercel（フロントエンド）へのデプロイ
      - name: Setup Node.js for Vercel
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Vercel CLI
        run: npm install -g vercel@39.1.0

      - name: Deploy to Vercel (Frontend)
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_USER_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          vercel pull --yes --environment=production --token=$VERCEL_TOKEN
          vercel build --prod --token=$VERCEL_TOKEN
          vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN

  # trivy-image-scan:
  #   name: Container Vulnerability Scan (Trivy)
  #   runs-on: ubuntu-latest

  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Setup Docker Buildx
  #       uses: docker/setup-buildx-action@v3

  #     - name: Build backend image
  #       run: |
  #         docker build -t app-backend:ci ./backend

  #     - name: Scan backend image (Trivy)
  #       uses: aquasecurity/trivy-action@0.28.0
  #       with:
  #         image-ref: app-backend:ci
  #         format: table
  #         ignore-unfixed: true
  #         severity: HIGH,CRITICAL
  #         exit-code: '1'
  #         # .trivyignoreファイルが自動的に読み込まれます

  #     - name: Build frontend image
  #       run: |
  #         docker build -t app-frontend:ci --target build ./frontend

  #     - name: Scan frontend image (Trivy)
  #       # ビルドステージのみをスキャン（本番環境で使用するnpmパッケージの脆弱性を検出）
  #       # nginxステージはスキップ（Vercelでは使用しないため）
  #       uses: aquasecurity/trivy-action@0.28.0
  #       with:
  #         image-ref: app-frontend:ci
  #         format: table
  #         ignore-unfixed: true
  #         severity: HIGH,CRITICAL
  #         exit-code: '1'

  # SBOM生成ジョブはDockerfileが必要なため無効化
  # デプロイでDockerfileを使用していないため、SBOM生成も不要
  # sbom:
  #   name: Generate SBOM (Syft)
  #   runs-on: ubuntu-latest

  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Build backend image
  #       run: |
  #         docker build -t app-backend:ci ./backend

  #     - name: Build frontend image
  #       run: |
  #         docker build -t app-frontend:ci --target build ./frontend

  #     - name: Install Syft
  #       run: |
  #         curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

  #     - name: Generate SBOM (backend and frontend)
  #       # フロントエンドはビルドステージのみ（本番環境で使用するnpmパッケージ）
  #       run: |
  #         syft app-backend:ci -o spdx-json > sbom-backend.spdx.json
  #         syft app-frontend:ci -o spdx-json > sbom-frontend.spdx.json

  #     - name: Upload SBOM artifacts
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: sbom
  #         path: |
  #           sbom-backend.spdx.json
  #           sbom-frontend.spdx.json

  # イメージ署名ジョブはDockerfileが必要なため無効化
  # デプロイでDockerfileを使用していないため、イメージ署名も不要
  # sign-images:
  #   name: Sign Images (cosign keyless)
  #   # mainブランチへのプッシュ時のみ実行（PRではスキップ）
  #   if: github.event_name == 'push' && github.ref == 'refs/heads/main'
  #   runs-on: ubuntu-latest

  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Setup Docker Buildx
  #       uses: docker/setup-buildx-action@v3

  #     - name: Login to GHCR
  #       uses: docker/login-action@v3
  #       with:
  #         registry: ghcr.io
  #         username: ${{ github.actor }}
  #         password: ${{ secrets.GITHUB_TOKEN }}

  #     - name: Build & push backend
  #       id: push_backend
  #       uses: docker/build-push-action@v6
  #       with:
  #         context: ./backend
  #         push: true
  #         tags: |
  #           ghcr.io/${{ github.repository }}-backend:latest
  #           ghcr.io/${{ github.repository }}-backend:${{ github.sha }}

  #     - name: Build & push frontend
  #       id: push_frontend
  #       uses: docker/build-push-action@v6
  #       with:
  #         context: ./frontend
  #         target: build  # ビルドステージのみ（本番環境で使用するnpmパッケージ）
  #         push: true
  #         tags: |
  #           ghcr.io/${{ github.repository }}-frontend:latest
  #           ghcr.io/${{ github.repository }}-frontend:${{ github.sha }}

  #     - name: Install Cosign
  #       uses: sigstore/cosign-installer@v3.8.1

  #     - name: Sign backend image
  #       env:
  #         COSIGN_EXPERIMENTAL: "true"
  #       run: |
  #         cosign sign --yes ghcr.io/${{ github.repository }}-backend@${{ steps.push_backend.outputs.digest }}

  #     - name: Sign frontend image
  #       env:
  #         COSIGN_EXPERIMENTAL: "true"
  #       run: |
  #         cosign sign --yes ghcr.io/${{ github.repository }}-frontend@${{ steps.push_frontend.outputs.digest }}
